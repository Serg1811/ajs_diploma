(()=>{"use strict";class t{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n        <div class="stats">\n        <span class="stats-name">Уровень: <span class="level"></span>\n        <span class="stats-name">Номер хода: <span class="stroke-number"></span>\n        <span class="stats-name">Очков: <span class="points"></span>\n        <span class="stats-name">Лучший результат: <span class="best-points"></span>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n      ',this._level=this.container.querySelector(".level"),this._strokeNumber=this.container.querySelector(".stroke-number"),this._points=this.container.querySelector(".points"),this._bestPoints=this.container.querySelector(".best-points"),this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(t=>this.onNewGameClick(t))),this.saveGameEl.addEventListener("click",(t=>this.onSaveGameClick(t))),this.loadGameEl.addEventListener("click",(t=>this.onLoadGameClick(t))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const a=document.createElement("div");a.classList.add("cell","map-tile","map-tile-"+(e=t,s=this.boardSize,0===e?"top-left":e===s-1?"top-right":e===s*s-s?"bottom-left":e===s*s-1?"bottom-right":Number.isInteger((s*s-e)/s)?"left":Number.isInteger((s*s-e-1)/s)?"right":e>0&&e<s?"top":e>s*s-s?"bottom":"center")),a.addEventListener("mouseenter",(t=>this.onCellEnter(t))),a.addEventListener("mouseleave",(t=>this.onCellLeave(t))),a.addEventListener("click",(t=>this.onCellClick(t))),this.boardEl.appendChild(a)}var e,s;this.cells=Array.from(this.boardEl.children)}get level(){return this._level.text}set level(t){this._level.innerText=t}get strokeNumber(){return this._strokeNumber.text}set strokeNumber(t){this._strokeNumber.innerText=t}get points(){return this._points.text}set points(t){this._points.innerText=t}get bestPoints(){return this._bestPoints.text}set bestPoints(t){this._bestPoints.innerText=t}redrawStatistic(t){this.level=t.level,this.strokeNumber=t.strokeNumber,this.points=t.points,this.bestPoints=t.points}redrawPositions(t){for(const t of this.cells)t.innerHTML="";for(const s of t){const t=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const i=document.createElement("div");i.classList.add("health-level");const o=document.createElement("div");o.classList.add("health-level-indicator","health-level-indicator-"+((e=s.character.health)<15?"critical":e<50?"normal":"high")),o.style.width=`${s.character.health}%`,i.appendChild(o),a.appendChild(i),t.appendChild(a)}var e}addCellEnterListener(t){this.cellEnterListeners.push(t)}addCellLeaveListener(t){this.cellLeaveListeners.push(t)}addCellClickListener(t){this.cellClickListeners.push(t)}addNewGameListener(t){this.newGameListeners.push(t)}addSaveGameListener(t){this.saveGameListeners.push(t)}addLoadGameListener(t){this.loadGameListeners.push(t)}onCellEnter(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach((t=>t.call(null,e)))}onCellLeave(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach((t=>t.call(null,e)))}onCellClick(t){const e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach((t=>t.call(null,e)))}onNewGameClick(t){t.preventDefault(),this.newGameListeners.forEach((t=>t.call(null)))}onSaveGameClick(t){t.preventDefault(),this.saveGameListeners.forEach((t=>t.call(null)))}onLoadGameClick(t){t.preventDefault(),this.loadGameListeners.forEach((t=>t.call(null)))}static showError(t){alert(t)}static showMessage(t){alert(t)}selectCell(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(t),this.cells[t].classList.add("selected",`selected-${e}`)}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter((t=>t.startsWith("selected"))))}showCellTooltip(t,e){this.cells[e].title=t}hideCellTooltip(t){this.cells[t].title=""}showDamage(t,e){return new Promise((s=>{const a=this.cells[t],i=document.createElement("span");i.textContent=e,i.classList.add("damage"),a.appendChild(i),i.addEventListener("animationend",(()=>{a.removeChild(i),s()}))}))}setCursor(t){this.boardEl.style.cursor=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}const e={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};class s{constructor(t){this.characters=t}}function a(t,e,a){const i=[],o=function*(t,e){for(;;){const s=Math.floor(Math.random()*t.length),a=Math.floor(1+Math.random()*e);yield new t[s](a)}}(t,e);for(let t=0;t<a;t+=1)i.push(o.next().value);return new s(i)}class i{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(new.target===i)throw Error("invalid Character() class used");if(this.level=1,this.attack=0,this.defence=0,this.health=50,this.type=e,t>1)for(let e=1;e<t;e++)this.raisingLevel()}raisingLevel(){this.level++,this.attack=+Math.max(this.attack,this.attack*(80+this.health)/100).toFixed(1),this.defence=+Math.max(this.defence,this.defence*(80+this.health)/100).toFixed(1),this.health=Math.min(100,this.health+80)}}class o extends i{constructor(t){super(t,"bowman"),this.attack=25,this.defence=25,this.movement=2,this.attackRange=2}}class r extends i{constructor(t){super(t,"daemon"),this.attack=10,this.defence=40,this.movement=1,this.attackRange=4}}class n extends i{constructor(t){super(t,"magician"),this.attack=10,this.defence=40,this.movement=1,this.attackRange=4}}class h extends i{constructor(t){super(t,"swordsman"),this.attack=40,this.defence=10,this.movement=4,this.attackRange=1}}class l extends i{constructor(t){super(t,"undead"),this.attack=40,this.defence=10,this.movement=4,this.attackRange=1}}class c extends i{constructor(t){super(t,"vampire"),this.attack=25,this.defence=25,this.movement=2,this.attackRange=2}}class d{constructor(t,e){if(!(t instanceof i))throw new Error("character must be instance of Character or its children");if("number"!=typeof e)throw new Error("position must be a number");this.character=t,this.position=e}}class m{constructor(t){this.positionsCharacters=t.positionsCharacters,this.level=t.level,this.points=t.points,this.activePositionCharacter=t.activePositionCharacter,this.strokeNumber=t.strokeNumber,this.points=t.points,this.bestPoints=t.bestPoints}saveBestPoints(t){t>this.bestPoints&&(this.bestPoints=t)}}const u="auto",p="pointer",v="crosshair",C="not-allowed";class g{constructor(t,e){this.gamePlay=t,this.stateService=e}#t=[o,h,n];#e=[c,l,r];#s={bowman:this.#t[0],swordsman:this.#t[1],magician:this.#t[2],vampire:this.#e[0],undead:this.#e[1],daemon:this.#e[2]};init(){this.users=new Map,this.comps=new Map,this.level=1,this.gamePlay.drawUi(e[Object.keys(e)[this.level-1]]),this.startGame(),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.onNewGameClick.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGameClick.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGameClick.bind(this))}onCellClick(e){const s=this.checkCharacterInCell(e);this.activePositionCharacter?s&&s===this.activePositionCharacter?(this.heroDeactivation(),this.gamePlay.redrawPositions(this.positionsCharacters)):s&&this.users.has(s)?(this.heroDeactivation(),this.gamePlay.selectCell(e),this.activePositionCharacter=s):s&&this.comps.has(s)&&this.users.get(this.activePositionCharacter).attackRange.includes(e)?(this.attack(this.activePositionCharacter,s),this.strokeNumber++,this.gamePlay.strokeNumber=this.strokeNumber,this.heroDeactivation(),setTimeout((()=>{this.comps.size>0?this.turnComp():this.levelUp()}),600)):!s&&this.users.get(this.activePositionCharacter).movement.includes(e)&&(this.movement(this.activePositionCharacter,e),this.strokeNumber++,this.gamePlay.strokeNumber=this.strokeNumber,this.heroDeactivation(),this.gamePlay.redrawPositions(this.positionsCharacters),setTimeout((()=>{this.turnComp()}),600)):s&&this.users.has(s)?(this.gamePlay.selectCell(e),this.activePositionCharacter=s):s&&this.comps.has(s)&&t.showError("Это не твой игрок")}onCellEnter(t){const e=this.checkCharacterInCell(t);e&&(this.gamePlay.showCellTooltip(g.findShow(e.character),t),this.users.has(e)?this.gamePlay.setCursor(p):this.gamePlay.setCursor(C)),this.activePositionCharacter&&(!e&&this.users.get(this.activePositionCharacter).movement.includes(t)?(this.gamePlay.selectCell(t,"green"),this.gamePlay.setCursor(p)):e&&this.comps.has(e)&&this.users.get(this.activePositionCharacter).attackRange.includes(t)?(this.gamePlay.selectCell(t,"red"),this.gamePlay.setCursor(v)):(!e||e&&this.comps.has(e))&&this.gamePlay.setCursor(C))}onCellLeave(t){const e=this.checkCharacterInCell(t);this.gamePlay.setCursor(u),e&&this.gamePlay.hideCellTooltip(t),this.activePositionCharacter&&(!e&&this.users.get(this.activePositionCharacter).movement.includes(t)||e&&this.comps.has(e)&&this.users.get(this.activePositionCharacter).attackRange.includes(t))&&this.gamePlay.deselectCell(t)}onNewGameClick(){this.startGame()}onSaveGameClick(){this.gameState=new m(this),this.stateService.save(this.gameState),t.showError("Игра сохранина")}onLoadGameClick(){if(0===this.stateService.storage.length)t.showError("Нет сохранённой игры");else{const t=this.stateService.load(),e=this.createPositionsCharacters(t.positionsCharacters);this.startGame(e,t.level,t.activePosition,t.strokeNumber,t.points,t.bestPoints)}t.showError("Игра загружена")}createPositionsCharacters(t){const e=[];return t.forEach((t=>{const s=new(0,this.#s[t.character.type])(t.character.level);s.attack=t.character.attack,s.defence=t.character.defence,s.health=t.character.health,e.push(new d(s,t.position))})),e}#a(){this.allowUserPositions=new Set;for(let t=0;t<this.gamePlay.boardSize;t++)this.allowUserPositions.add(t*this.gamePlay.boardSize),this.allowUserPositions.add(t*this.gamePlay.boardSize+1)}#i(){this.allowCompPositions=new Set;for(let t=1;t<this.gamePlay.boardSize+1;t++)this.allowCompPositions.add(t*this.gamePlay.boardSize-2),this.allowCompPositions.add(t*this.gamePlay.boardSize-1)}#o(){this.allowUserPositions=new Set,this.allowCompPositions=new Set;for(const t of this.gameZone)this.allowUserPositions.add(t[0]),this.allowUserPositions.add(t[1]),this.allowCompPositions.add(t.at(-2)),this.allowCompPositions.add(t.at(-1))}#r(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.gamePlay.boardSize;this.gameZone=[];for(let e=0;e<t;e++){this.gameZone.push([]);for(let s=0;s<t;s++)this.gameZone[e].push(e*t+s)}}startTeam(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const s=Math.floor(1+4*Math.random());let i=Math.floor(1+Math.random()*this.gamePlay.boardSize);return(t.length>=i||e.length>=i)&&(i=Math.max(t.length,e.length)),{user:[...t,...a(this.#t,s,i-t.length).characters],comp:[...e,...a(this.#e,s,i-e.length).characters]}}startPositions(t){this.#o();const e=[];return t.user.forEach((t=>{const s=Array.from(this.allowUserPositions),a=s[Math.floor(Math.random()*s.length)],i=new d(t,a);this.positionCharacterAdd(this.users,i),e.push(i),this.allowUserPositions.delete(a)})),t.comp.forEach((t=>{const s=Array.from(this.allowCompPositions),a=s[Math.floor(Math.random()*s.length)],i=new d(t,a);this.positionCharacterAdd(this.comps,i),e.push(i),this.allowCompPositions.delete(a)})),delete this.allowUserPositions,delete this.allowCompPositions,e}startGame(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;this.users.clear(),this.comps.clear(),this.level=s,this.strokeNumber=i,this.points=o,this.bestPoints=r;const n=Object.keys(e);if(this.gamePlay.drawUi(e[n[(this.level-1)%n.length]]),this.#r(this.gamePlay.boardSize),null===t){const e=this.startTeam();t=this.startPositions(e)}else t.forEach((t=>{const e=this.#t.find((e=>t.character instanceof e))?this.users:this.comps;this.positionCharacterAdd(e,t),t.position===a&&(this.activePositionCharacter=t)}));this.positionsCharacters=t,this.gamePlay.redrawPositions(this.positionsCharacters),this.gamePlay.redrawStatistic({level:this.level,strokeNumber:this.strokeNumber,points:this.points,bestPoints:this.bestPoints})}checkCharacterInCell(t){return this.positionsCharacters.find((e=>e.position===t))}static findShow(t){return`🎖 ${t.level} ⚔ ${t.attack} 🛡 ${t.defence} ❤ ${t.health}`}zone(e,s,a){a||(a=s.position);const i=s.character[e];if(i){const t=Math.floor(a/this.gamePlay.boardSize),e=a%this.gamePlay.boardSize;let s=t-i;const o=t+i+1;let r=e-i;const n=e+i+1;s=s<0?0:s,r=r<0?0:r;const h=[];this.gameZone.slice(s,o).forEach((t=>{h.push(...t.slice(r,n))}));const l=h.indexOf(a);return h.splice(l,1),h}t.showError(`У ${s.character} отсутствует свойство ${e}`)}positionCharacterAdd(t,e){return t.set(e,{movement:this.zone("movement",e),attackRange:this.zone("attackRange",e)})}heroDeactivation(){this.gamePlay.deselectCell(this.activePositionCharacter.position),this.gamePlay.setCursor(u),this.activePositionCharacter=void 0}attack(t,e){let s=this.users,a=this.comps;this.users.has(e)&&(a=this.users,s=this.comps);const i=+Math.max(t.character.attack-e.character.defence,.1*t.character.attack).toFixed(1);e.character.health-=i,e.character.health=+e.character.health.toFixed(1),(async()=>{await this.gamePlay.showDamage(e.position,i),this.gamePlay.redrawPositions(this.positionsCharacters)})(),e.character.health<=0&&this.death(a,e),s.get(t).attackRange=this.zone("attackRange",t),this.gamePlay.deselectCell(e.position)}movement(t,e){this.gamePlay.deselectCell(t.position),t.position=e;const s=this.users.has(t)?this.users:this.comps;this.positionCharacterAdd(s,t)}death(t,e){this.positionsCharacters.splice(this.positionsCharacters.findIndex((t=>t===e)),1),t.delete(e)}turnComp(){const t=[],e=[],s=new Map,a=this.positionsCharacters.map((t=>t.position));for(const[e,i]of this.comps)for(const[o,r]of this.users)i.attackRange.includes(o.position)?t.push({attacker:e,attacked:o}):i.movement.forEach((t=>{if(!a.includes(t)){const a={positionCharacter:e,positionMovement:t},i=r.movement.includes(t)?o.character.attack:0;(!s.has(a)||s.get(a)<i)&&s.set(a,i)}}));if(t.length>0)t.sort(((t,e)=>e.attacker.character.attack-t.attacker.character.attack||e.attacked.character.attack-t.attacked.character.attack)),this.attack(t[0].attacker,t[0].attacked),setTimeout((()=>{0===this.users.size&&this.gameOver()}),1e4);else{for(const[t,a]of s)e.push({positionCharacter:t.positionCharacter,damage:a,positionMovement:t.positionMovement});e.sort(((t,e)=>t.damage-e.damage||e.positionCharacter.character.attack-t.positionCharacter.character.attack)),this.movement(e[0].positionCharacter,e[0].positionMovement)}setTimeout((()=>{this.gamePlay.redrawPositions(this.positionsCharacters)}),600)}levelUp(){this.level++,this.strokeNumber=1;const t=[];for(const e of this.users.keys())this.points+=e.character.health,this.points=+this.points.toFixed(1),e.character.raisingLevel(),t.push(e.character);this.bestPoints=Math.max(this.points,this.bestPoints);const e=this.startTeam(t);this.startGame(this.startPositions(e),this.level,void 0,void 0,this.points,this.bestPoints)}gameOver(){t.showError("Game over!"),this.clearCellListeners()}}const P=new t;P.bindToDOM(document.querySelector("#game-container"));const k=new class{constructor(t){this.storage=t}save(t){this.storage.setItem("state",JSON.stringify(t))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(t){throw new Error("Invalid state")}}}(localStorage);new g(P,k).init()})();